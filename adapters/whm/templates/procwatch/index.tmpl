[%-
USE Whostmgr;
USE JSON;

IF locale.get_html_dir_attr() == 'rtl';
    SET rtl_bootstrap = Whostmgr.find_file_url('/3rdparty/bootstrap-rtl/optimized/dist/css/bootstrap-rtl.min.css');
END;

SET styleSheets = [];
IF rtl_bootstrap;
    styleSheets.push(rtl_bootstrap);
END;

WRAPPER 'master_templates/master.tmpl'
    header = locale.maketext("ProcWatch")
    stylesheets = styleSheets,
    theme='bootstrap';
-%]

<div id="procwatch" class="pw-root">
  <div class="pw-top">
    <div class="pw-title">
      <div class="pw-h1">ProcWatch</div>
      <div class="pw-sub">Fast, process-aware snapshots for WHM. Refreshes every 5 seconds. No history (MVP).</div>
    </div>

    <div class="pw-meta">
      <span class="pw-pill">Host: <b id="host">-</b></span>
      <span class="pw-pill">Last update: <b id="ts">-</b></span>
      <span class="pw-pill pw-warn" id="warnPill" style="display:none;">⚠ <b id="warnText">partial data</b></span>
    </div>
  </div>

  <div class="pw-grid">
    <!-- Row 1: 4 metric cards -->
    <div class="pw-card pw-span-3">
      <div class="pw-hd"><div class="pw-k">CPU</div><div class="pw-t">user/sys/iowait</div></div>
      <div class="pw-bd">
        <div class="pw-metric">
          <div><span class="pw-big" id="cpuPct">-</span><span class="pw-unit">%</span></div>
          <div class="pw-right" id="cpuBreak">-</div>
        </div>
        <div class="pw-bar"><span id="cpuBar"></span></div>
        <div class="pw-subgrid">
          <div class="pw-kv"><span>IO wait</span><b id="iowait">-</b></div>
          <div class="pw-kv"><span>Note</span><b>snapshot</b></div>
        </div>
      </div>
    </div>

    <div class="pw-card pw-span-3">
      <div class="pw-hd"><div class="pw-k">Memory</div><div class="pw-t">used/total</div></div>
      <div class="pw-bd">
        <div class="pw-metric">
          <div><span class="pw-big" id="memUsed">-</span><span class="pw-unit">GB</span></div>
          <div class="pw-right" id="memMeta">-</div>
        </div>
        <div class="pw-bar"><span id="memBar"></span></div>
        <div class="pw-subgrid">
          <div class="pw-kv"><span>Available</span><b id="memAvail">-</b></div>
          <div class="pw-kv"><span>Swap used</span><b id="swapUsed">-</b></div>
        </div>
      </div>
    </div>

    <div class="pw-card pw-span-3">
      <div class="pw-hd"><div class="pw-k">Load average</div><div class="pw-t">1/5/15</div></div>
      <div class="pw-bd">
        <div class="pw-metric">
          <div><span class="pw-big" id="l1">-</span><span class="pw-unit">1m</span></div>
          <div class="pw-right" id="loads">-</div>
        </div>
        <div class="pw-bar"><span id="loadBar"></span></div>
        <div class="pw-subgrid">
          <div class="pw-kv"><span>Hint</span><b id="loadHint">-</b></div>
          <div class="pw-kv"><span>Note</span><b>relative</b></div>
        </div>
      </div>
    </div>

    <div class="pw-card pw-span-3">
      <div class="pw-hd"><div class="pw-k">Disk</div><div class="pw-t">/</div></div>
      <div class="pw-bd">
        <div class="pw-metric">
          <div><span class="pw-big" id="diskPct">-</span><span class="pw-unit">%</span></div>
          <div class="pw-right" id="diskMeta">-</div>
        </div>
        <div class="pw-bar"><span id="diskBar"></span></div>
        <div class="pw-subgrid">
          <div class="pw-kv"><span>Used</span><b id="diskUsed">-</b></div>
          <div class="pw-kv"><span>Free</span><b id="diskFree">-</b></div>
        </div>
      </div>
    </div>

    <!-- Row 2: Top accounts + Top processes -->
    <div class="pw-card pw-span-6">
      <div class="pw-hd"><div class="pw-k">Top accounts</div><div class="pw-t">by CPU (snapshot)</div></div>
      <div class="pw-bd pw-pad-top">
        <table class="pw-table">
          <thead><tr><th>User</th><th>Top pool</th><th class="pw-num">CPU%</th><th class="pw-num">RAM</th><th class="pw-num">PHP</th><th class="pw-num">Proc</th></tr></thead>
          <tbody id="tblAccounts"></tbody>
        </table>
      </div>
    </div>

    <div class="pw-card pw-span-6">
      <div class="pw-hd"><div class="pw-k">Top processes</div><div class="pw-t">CPU/RAM/elapsed</div></div>
      <div class="pw-bd pw-pad-top">
        <table class="pw-table">
          <thead><tr><th>PID</th><th>User</th><th>Command</th><th class="pw-num">CPU%</th><th class="pw-num">RAM</th><th class="pw-num">Elapsed</th></tr></thead>
          <tbody id="tblProcs"></tbody>
        </table>
      </div>
    </div>

    <!-- Row 3: Pools -->
    <div class="pw-card pw-span-12">
      <div class="pw-hd"><div class="pw-k">Top PHP-FPM pools</div><div class="pw-t">pool-level view</div></div>
      <div class="pw-bd pw-pad-top">
        <table class="pw-table">
          <thead><tr><th>Pool</th><th>Owner</th><th class="pw-num">CPU%</th><th class="pw-num">RAM</th><th class="pw-num">Workers</th><th class="pw-num">Max elapsed</th></tr></thead>
          <tbody id="tblPools"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="pw-footer">
    ProcWatch <b>v1.0.0</b> •
    <a class="pw-link" href="https://github.com/afbora/procwatch/releases/tag/1.0.0" target="_blank" rel="noreferrer">GitHub release</a>
  </div>
</div>

<style>
/* Light theme defaults (WHM-friendly). */
#procwatch{
  --pw-bg: #ffffff;
  --pw-surface: #ffffff;
  --pw-surface2: rgba(17,24,39,.02);
  --pw-text: #111827;
  --pw-muted: #6b7280;
  --pw-border: rgba(17,24,39,.10);
  --pw-shadow: 0 10px 20px rgba(0,0,0,.08);
  --pw-radius: 14px;
  --pw-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --pw-sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
  --pw-accent: rgba(53,208,127,.95);
  --pw-warn: rgba(245, 158, 11, .18);
  --pw-warnBorder: rgba(245, 158, 11, .35);
  font-family: var(--pw-sans);
  color: var(--pw-text);
}

/* Local reset (avoid WHM global CSS collisions) */
#procwatch, #procwatch * { box-sizing: border-box; }
#procwatch table { border-collapse: collapse !important; }

.pw-root{
  margin:18px auto 28px;
  padding:0 12px;
  max-width: 980px;
}
@media (min-width: 1368px) { .pw-root { max-width: 1200px; } }
@media (min-width: 1920px) { .pw-root { max-width: 1600px; } }

.pw-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:14px;}
.pw-h1{font-size:18px;font-weight:750;letter-spacing:.2px;}
.pw-sub{margin-top:4px;color:var(--pw-muted);font-size:12px;line-height:1.35;max-width:760px;}
.pw-meta{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap;}
.pw-pill{padding:7px 9px;border:1px solid var(--pw-border);background:var(--pw-surface2);border-radius:999px;font-size:12px;color:var(--pw-muted);box-shadow:0 8px 16px rgba(0,0,0,.05);}
.pw-warn{background:var(--pw-warn);border-color:var(--pw-warnBorder);}

.pw-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;}
.pw-card{min-width:0;background:var(--pw-surface);border:1px solid var(--pw-border);border-radius:var(--pw-radius);box-shadow:var(--pw-shadow);overflow:hidden;}
.pw-hd{padding:12px 14px 9px;display:flex;align-items:center;justify-content:space-between;gap:10px;border-bottom:1px solid var(--pw-border);background:var(--pw-surface2);}
.pw-k{font-weight:700;font-size:12px;letter-spacing:.2px;}
.pw-t{font-family:var(--pw-mono);font-size:11px;color:var(--pw-muted);}
.pw-bd{padding:12px 14px 14px;}
.pw-metric{display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin:2px 0 8px;}
.pw-big{font-size:24px;font-weight:800;}
.pw-unit{font-size:12px;color:var(--pw-muted);margin-left:6px;}
.pw-right{text-align:right;color:var(--pw-muted);font-size:11px;font-family:var(--pw-mono);line-height:1.35;}
.pw-bar{height:9px;background:var(--pw-surface2);border:1px solid var(--pw-border);border-radius:999px;overflow:hidden;}
.pw-bar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,rgba(53,208,127,.95),rgba(255,204,102,.95),rgba(255,92,122,.95));transition:width .55s ease;}
.pw-subgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:9px;}
.pw-kv{padding:9px;border:1px solid var(--pw-border);border-radius:12px;background:var(--pw-surface2);display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--pw-muted);}
.pw-kv b{color:var(--pw-text);font-weight:700;font-family:var(--pw-mono);}

.pw-span-3{grid-column:span 3;}
.pw-span-6{grid-column:span 6;}
.pw-span-12{grid-column:span 12;}

@media (max-width:980px){
  .pw-span-3{grid-column:span 12;}
  .pw-span-6{grid-column:span 12;}
  .pw-top{flex-direction:column;align-items:flex-start}
  .pw-meta{justify-content:flex-start}
}

table.pw-table{width:100%;font-size:12px;color:var(--pw-text);border-radius:12px;overflow:hidden;}
.pw-table th,.pw-table td{text-align:left;padding:9px;border-bottom:1px solid var(--pw-border);white-space:nowrap;vertical-align:middle;}
.pw-table th{color:var(--pw-muted);font-weight:700;font-size:11px;letter-spacing:.2px;text-transform:uppercase;background:var(--pw-surface2);}
.pw-table tbody tr:hover{background:var(--pw-surface2);}
.pw-num{font-family:var(--pw-mono);text-align:right;}
.pw-pad-top{padding-top:9px;}

.pw-footer{margin-top:12px;color:var(--pw-muted);font-size:12px;line-height:1.45;}
.pw-link{color:var(--pw-muted);text-decoration:underline;}
.pw-link:hover{color:var(--pw-text);}
</style>

<script>
(function(){
  const fmtGB=(kb)=> (kb/1024/1024).toFixed(2)+" GB";
  const fmtMB=(kb)=>{const mb=kb/1024; if(mb>=1024) return (mb/1024).toFixed(2)+" GB"; return mb.toFixed(0)+" MB";};
  const pct=(permille)=> (permille/10).toFixed(1);
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const loadHint=(l1)=>{ if(l1<0.8) return "OK"; if(l1<2.0) return "Busy"; return "High"; };

  async function fetchMetrics(){
    const res = await fetch("index.cgi?action=metrics", { cache: "no-store" });
    return await res.json();
  }

  function setBar(id,val){ document.getElementById(id).style.width=clamp(val,0,100)+"%"; }

  function render(m){
    const ts=new Date((m.ts||0)*1000);
    document.getElementById("host").textContent=window.location.hostname||"server";
    document.getElementById("ts").textContent=isNaN(ts.getTime())?"-":ts.toLocaleTimeString();

    const warnPill = document.getElementById("warnPill");
    if (m.partial) {
      const w = (m.warnings || []).slice(0,3).join(", ") || "partial data";
      document.getElementById("warnText").textContent = w;
      warnPill.style.display = "inline-flex";
    } else {
      warnPill.style.display = "none";
    }

    document.getElementById("cpuPct").textContent=pct(m.cpu.pct||0);
    document.getElementById("cpuBreak").innerHTML=`user ${pct(m.cpu.user||0)}%<br>sys ${pct(m.cpu.sys||0)}%<br>iowait ${pct(m.cpu.iowait||0)}%`;
    document.getElementById("iowait").textContent=pct(m.cpu.iowait||0)+"%";
    setBar("cpuBar",(m.cpu.pct||0)/10);

    const total=m.mem.mem_total_kb||0, avail=m.mem.mem_avail_kb||0, used=Math.max(0,total-avail);
    document.getElementById("memUsed").textContent=(used/1024/1024).toFixed(1);
    document.getElementById("memMeta").innerHTML=`${fmtGB(used)} / ${fmtGB(total)}<br><span style="color:var(--pw-muted);font-family:var(--pw-mono);">${((used/total)*100||0).toFixed(1)}% used</span>`;
    document.getElementById("memAvail").textContent=fmtGB(avail);
    const swapUsed=Math.max(0,(m.mem.swap_total_kb||0)-(m.mem.swap_free_kb||0));
    document.getElementById("swapUsed").textContent=fmtGB(swapUsed);
    setBar("memBar",(used/total)*100||0);

    document.getElementById("l1").textContent=(m.load.l1||0).toFixed(2);
    document.getElementById("loads").textContent=`${(m.load.l1||0).toFixed(2)} / ${(m.load.l5||0).toFixed(2)} / ${(m.load.l15||0).toFixed(2)}`;
    document.getElementById("loadHint").textContent=loadHint(m.load.l1||0);
    setBar("loadBar",Math.min(100,(m.load.l1||0)*25));

    document.getElementById("diskPct").textContent=(m.disk.used_pct||0);
    document.getElementById("diskMeta").textContent=`${fmtGB(m.disk.used_kb||0)} / ${fmtGB(m.disk.total_kb||0)}`;
    document.getElementById("diskUsed").textContent=fmtGB(m.disk.used_kb||0);
    document.getElementById("diskFree").textContent=fmtGB(m.disk.free_kb||0);
    setBar("diskBar",m.disk.used_pct||0);

    const a=document.getElementById("tblAccounts"); a.innerHTML="";
    (m.accounts||[]).forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.user}</td><td style="color:var(--pw-muted);font-family:var(--pw-mono);">${r.top_pool||"-"}</td><td class="pw-num">${(r.cpu||0).toFixed(1)}</td><td class="pw-num">${fmtMB(r.rss_kb||0)}</td><td class="pw-num">${r.php||0}</td><td class="pw-num">${r.proc||0}</td>`;
      a.appendChild(tr);
    });

    const p=document.getElementById("tblProcs"); p.innerHTML="";
    (m.procs||[]).forEach(r=>{
      const cmd=(r.cmd||"").length>52?(r.cmd||"").slice(0,52)+"...":(r.cmd||"");
      const tr=document.createElement("tr");
      tr.innerHTML=`<td style="color:var(--pw-muted);font-family:var(--pw-mono);">${r.pid}</td><td>${r.user}</td><td style="color:var(--pw-muted);font-family:var(--pw-mono);" title="${(r.cmd||"").replaceAll('"','&quot;')}">${cmd}</td><td class="pw-num">${(r.cpu||0).toFixed(1)}</td><td class="pw-num">${fmtMB(r.rss_kb||0)}</td><td class="pw-num">${r.elapsed||"-"}</td>`;
      p.appendChild(tr);
    });

    const pools=document.getElementById("tblPools"); pools.innerHTML="";
    (m.pools||[]).forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.pool}</td><td style="color:var(--pw-muted);font-family:var(--pw-mono);">${r.owner}</td><td class="pw-num">${(r.cpu||0).toFixed(1)}</td><td class="pw-num">${fmtMB(r.rss_kb||0)}</td><td class="pw-num">${r.workers||0}</td><td class="pw-num">${r.max_elapsed||"-"}</td>`;
      pools.appendChild(tr);
    });
  }

  async function tick(){
    try { render(await fetchMetrics()); } catch(e) {}
  }

  tick();
  setInterval(tick, 5000);
})();
</script>

[% END %]
